<div class="max-w-5xl mx-auto space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <a href="/dashboard/settings/templates" class="text-xs text-primary-600 dark:text-primary-400 hover:underline mb-1 inline-block">‚Üê Back to Templates</a>
      <h2 class="text-xl font-bold"><%= template.label %> ‚Äî Field Editor</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Rename PDF fields to standard names so the system can auto-fill them with submission data.</p>
    </div>
  </div>

  <% if (typeof success !== 'undefined' && success && success.length) { %>
    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300 px-4 py-3 rounded-xl text-sm"><%= success %></div>
  <% } %>
  <% if (typeof error !== 'undefined' && error && error.length) { %>
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 px-4 py-3 rounded-xl text-sm"><%= error %></div>
  <% } %>

  <!-- Legend + Field Map -->
  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <p class="text-xs text-blue-700 dark:text-blue-300">
        <strong>How it works:</strong> For each PDF field, select a standard name from the dropdown. Fields with standard names will be automatically filled from submission data.
      </p>
      <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
        <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span> Mapped &nbsp;
        <span class="inline-block w-2 h-2 rounded-full bg-gray-400 mr-1"></span> Not mapped
      </p>
    </div>
    <a href="/dashboard/settings/templates/<%= template.key %>/fieldmap" 
      class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-xs font-medium transition-colors whitespace-nowrap flex-shrink-0">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
      Field Map
    </a>
    <form action="/dashboard/settings/templates/<%= template.key %>/automap" method="POST" class="inline"
      onsubmit="if(!confirm('AI will analyze this PDF and auto-rename fields. This may take a moment. Continue?')) return false; this.querySelector('button').disabled=true; this.querySelector('button').innerHTML='‚è≥ Analyzing...';">
      <button type="submit"
        class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl text-xs font-medium transition-colors whitespace-nowrap flex-shrink-0">
        ü§ñ AI Auto-Map
      </button>
    </form>
  </div>

  <form action="/dashboard/settings/templates/<%= template.key %>/fields" method="POST">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
        <h3 class="text-base font-semibold">Form Fields (<%= fields.length %>)</h3>
        <button type="submit" class="px-5 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-xl text-sm font-medium transition-colors">
          Save Changes
        </button>
      </div>

      <div class="divide-y divide-gray-100 dark:divide-gray-800">
        <% fields.forEach((f, i) => {
          const isMapped = !!standardFields[f.name];
        %>
          <div class="px-6 py-3 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 <%= isMapped ? 'bg-green-50/50 dark:bg-green-900/10' : '' %>">
            <!-- Index + Status -->
            <div class="flex items-center gap-2 sm:w-8">
              <span class="text-xs text-gray-400 font-mono"><%= i + 1 %></span>
              <span class="w-2 h-2 rounded-full flex-shrink-0 <%= isMapped ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600' %>"></span>
            </div>

            <!-- Current name -->
            <div class="sm:w-60 flex-shrink-0">
              <span class="text-xs text-gray-400">Current:</span>
              <code class="ml-1 text-sm font-mono text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded"><%= f.name %></code>
              <span class="text-xs text-gray-400 ml-1">(<%= f.type %>)</span>
            </div>

            <!-- Rename to -->
            <div class="flex-1 flex items-center gap-2">
              <span class="text-xs text-gray-400 flex-shrink-0">‚Üí</span>
              <select name="rename[<%= f.name %>]"
                class="flex-1 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500"
                onchange="highlightRow(this)">
                <option value="">‚Äî Keep as is ‚Äî</option>
                <%
                  // Group standard fields
                  const groups = {};
                  Object.entries(standardFields).forEach(([key, val]) => {
                    if (!groups[val.group]) groups[val.group] = [];
                    groups[val.group].push({ key, ...val });
                  });
                  Object.entries(groups).forEach(([groupName, items]) => {
                %>
                  <optgroup label="<%= groupName %>">
                    <% items.forEach(item => { %>
                      <option value="<%= item.key %>" <%= f.name === item.key ? 'disabled' : '' %>><%= item.key %> ‚Äî <%= item.label %></option>
                    <% }) %>
                  </optgroup>
                <% }) %>
              </select>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex justify-end">
        <button type="submit" class="px-5 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-xl text-sm font-medium transition-colors">
          Save Changes
        </button>
      </div>
    </div>
  </form>
</div>

<script>
function highlightRow(el) {
  const row = el.closest('.divide-y > div');
  if (el.value) {
    row.classList.add('bg-yellow-50/50', 'dark:bg-yellow-900/10');
  } else {
    row.classList.remove('bg-yellow-50/50', 'dark:bg-yellow-900/10');
  }
}
</script>

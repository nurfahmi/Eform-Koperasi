<% if (typeof success !== 'undefined' && success && success.length > 0) { %>
  <div class="bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 text-sm px-4 py-3 rounded-xl mb-6"><%= success %></div>
<% } %>

<div class="mb-4">
  <a href="/dashboard/cases" class="text-primary-600 dark:text-primary-400 hover:underline text-sm">‚Üê Back to Cases</a>
</div>

<%
const labels = {
  name: 'Nama', ic: 'No KP', phone: 'No Tel', email: 'Email',
  address: 'Alamat Terkini', tanggungan: 'Bil. Tanggungan', pendidikan: 'Taraf Pendidikan',
  jenis_kediaman: 'Jenis Kediaman', tempoh_menetap: 'Tempoh Menetap',
  nama_ibu: 'Nama Ibu', ic_ibu: 'No KP Ibu', alamat_ibu: 'Alamat Ibu',
  jawatan: 'Jawatan', alamat_majikan: 'Alamat Majikan',
  tel_pejabat: 'Tel Pejabat', gaji: 'Gaji (RM)',
  employer: 'Nama Majikan', position: 'Jawatan',
  tarikh_mula: 'Tarikh Mula Berkhidmat', salary: 'Gaji Bersih (RM)',
  payslip_link: 'Payslip Link', payslip_password: 'ANM/Payslip Password',
  hrmis_password: 'HRMIS Password',
  relationship: 'Pertalian'
};
function label(key) { return labels[key] || key.replace(/_/g, ' '); }
%>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Submission Info -->
  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6 space-y-4">
    <h3 class="text-base font-semibold mb-2">Submission Info</h3>
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div><span class="text-gray-500 dark:text-gray-400">ID:</span></div>
      <div class="font-mono text-xs"><%= submission.id %></div>
      <div><span class="text-gray-500 dark:text-gray-400">Referral:</span></div>
      <div><%= submission.referral_code || '-' %></div>

      <div><span class="text-gray-500 dark:text-gray-400">Date:</span></div>
      <div><%= new Date(submission.created_at).toLocaleString() %></div>
      <% if (submission.taken_by_name) { %>
        <div><span class="text-gray-500 dark:text-gray-400">Taken By:</span></div>
        <div><%= submission.taken_by_name %></div>
        <div><span class="text-gray-500 dark:text-gray-400">Taken At:</span></div>
        <div class="text-xs"><%= submission.taken_at ? new Date(submission.taken_at).toLocaleString() : '-' %></div>
      <% } %>
      <% if (submission.released_at) { %>
        <div><span class="text-gray-500 dark:text-gray-400">Last Released:</span></div>
        <div class="text-xs"><%= new Date(submission.released_at).toLocaleString() %></div>
        <div><span class="text-gray-500 dark:text-gray-400">Release Reason:</span></div>
        <div class="text-xs"><%= submission.release_reason || '-' %></div>
      <% } %>
    </div>

    <% if (user.role === 'superadmin' || user.role === 'admin') { %>


    <% if (submission.taken_by) { %>
    <form method="POST" action="/dashboard/cases/<%= submission.id %>/release" class="mt-4 space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Release Reason</label>
      <textarea name="release_reason" rows="2" required class="w-full px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" placeholder="Sebab lepaskan kes..."></textarea>
      <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl text-sm font-medium transition-colors">Release Case</button>
    </form>
    <% } %>
    <% } %>
  </div>

  <!-- Applicant Data -->
  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
    <h3 class="text-base font-semibold mb-3">Maklumat Pemohon</h3>
    <div class="space-y-2 text-sm">
      <% if (submission.applicant_data) { Object.entries(submission.applicant_data).forEach(([k,v]) => { %>
        <div class="flex justify-between gap-4"><span class="text-gray-500 dark:text-gray-400 shrink-0"><%= label(k) %>:</span><span class="text-right"><%= v || '-' %></span></div>
      <% })} %>
    </div>
  </div>

  <!-- Spouse Data -->
  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
    <h3 class="text-base font-semibold mb-3">Maklumat Pasangan</h3>
    <div class="space-y-2 text-sm">
      <% if (submission.spouse_data) { Object.entries(submission.spouse_data).forEach(([k,v]) => { %>
        <div class="flex justify-between gap-4"><span class="text-gray-500 dark:text-gray-400 shrink-0"><%= label(k) %>:</span><span class="text-right"><%= v || '-' %></span></div>
      <% })} %>
    </div>
  </div>

  <!-- Job Data -->
  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
    <h3 class="text-base font-semibold mb-3">Maklumat Pekerjaan</h3>
    <div class="space-y-2 text-sm">
      <% if (submission.job_data) { Object.entries(submission.job_data).forEach(([k,v]) => { %>
        <div class="flex justify-between gap-4"><span class="text-gray-500 dark:text-gray-400 shrink-0"><%= label(k) %>:</span><span class="text-right"><%= v || '-' %></span></div>
      <% })} %>
    </div>
  </div>

  <!-- Reference Data -->
  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
    <h3 class="text-base font-semibold mb-3">Rujukan Saudara</h3>
    <div class="space-y-2 text-sm">
      <% if (submission.reference_data) { Object.entries(submission.reference_data).forEach(([k,v]) => { %>
        <div class="flex justify-between gap-4"><span class="text-gray-500 dark:text-gray-400 shrink-0"><%= label(k) %>:</span><span class="text-right"><%= v || '-' %></span></div>
      <% })} %>
    </div>
  </div>

  <!-- Files -->
  <div class="lg:col-span-2 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
    <h3 class="text-base font-semibold mb-3">Dokumen</h3>
    <% if (files.length === 0) { %>
      <p class="text-sm text-gray-400">No files uploaded</p>
    <% } else { %>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
        <% files.forEach(f => { %>
          <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-3 flex items-center justify-between">
            <span class="text-xs font-medium capitalize"><%= f.file_type.replace(/_/g, ' ') %></span>
            <% if (user.role === 'superadmin' || user.role === 'admin') { %>
              <a href="/dashboard/files/<%= f.id %>/download" class="text-primary-600 dark:text-primary-400 text-xs hover:underline">Download</a>
            <% } %>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>

  <% if (submission.taken_by && typeof loanProducts !== 'undefined' && loanProducts.length > 0) { %>
  <!-- Loan Product PDF Download -->
  <div class="lg:col-span-2 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
    <h3 class="text-base font-semibold mb-2">üìÑ Borang Produk</h3>
    <p class="text-xs text-gray-400 mb-4">Pilih produk pinjaman dan lihat atau muat turun borang yang telah diisi secara automatik.</p>
    <div class="flex flex-col sm:flex-row gap-3">
      <select id="loanProductSelect" class="flex-1 px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500">
        <option value="">-- Pilih Produk --</option>
        <% loanProducts.forEach(p => { %>
          <option value="<%= p.key %>"><%= p.label %></option>
        <% }) %>
      </select>
      <button onclick="viewLoanPdf()"
        class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl text-sm font-medium transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
        View PDF
      </button>
      <button onclick="downloadLoanPdf()"
        class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-xl text-sm font-medium transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
        Download
      </button>
    </div>
  </div>
  <script>
    function getPdfUrl() {
      const sel = document.getElementById('loanProductSelect');
      if (!sel.value) { alert('Sila pilih produk terlebih dahulu.'); return null; }
      return '/dashboard/cases/<%= submission.id %>/pdf/' + sel.value;
    }
    function viewLoanPdf() {
      const url = getPdfUrl();
      if (url) window.open(url + '?view=1', '_blank');
    }
    function downloadLoanPdf() {
      const url = getPdfUrl();
      if (url) window.location.href = url;
    }
  </script>
  <% } %>
</div>

